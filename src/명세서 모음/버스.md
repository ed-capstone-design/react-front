# BusContext 구조 및 회사(operatorId) 기반 데이터 관리 방식

## 1. BusContext 주요 기능

- **버스 목록 조회**: fetchBuses()
- **버스 추가**: addBus(busData)
- **버스 수정**: updateBus(busId, busData)
- **버스 삭제**: deleteBus(busId)
- **특정 버스 조회**: getBusById(busId)
- **버스 통계**: getBusStats()
- **에러 관리**: error, clearError()

---

## 2. 기존 데이터 흐름

- **fetchBuses**: `/api/buses`로 전체 버스 목록을 요청
- **addBus/updateBus**: 별도의 회사 정보(operatorId) 없이 busData만 전달
- **operatorId**는 버스 데이터에 포함되어 있지만, 프론트에서 직접 입력받거나 관리하지 않음

---

## 3. 개선 방향: 회사(operatorId) 기반 데이터 관리

### 목적
- 각 회사(운영사)별로 자신의 버스 정보만 조회/추가/수정/삭제할 수 있도록 보안 및 데이터 무결성 강화

### 개선 방법

#### 1) operatorId를 토큰에서 추출
- useToken 훅 또는 jwt-decode 등으로 토큰에서 operatorId 추출

#### 2) 버스 목록 조회 시 operatorId를 쿼리로 전달
```js
const response = await axios.get("/api/buses", {
  params: { operatorId }
});
```

#### 3) 버스 추가/수정 시 operatorId를 busData에 자동 포함
```js
const response = await axios.post("/api/buses", { ...busData, operatorId });
const response = await axios.put(`/api/buses/${busId}`, { ...busData, operatorId });
```

#### 4) 회사명(운영사명) 입력란 제거
- 사용자가 회사명을 직접 입력하지 않고, 항상 토큰에서 추출한 operatorId를 사용

#### 5) 서버에서는 반드시 토큰의 operatorId와 요청값의 operatorId가 일치하는지 검증

---

## 4. 기대 효과

- **보안 강화**: 다른 회사 데이터 접근/조작 방지
- **API 일관성**: 모든 요청에 operatorId가 명확히 포함
- **유지보수 용이**: 회사별 데이터 분리 및 관리가 쉬워짐

---

## 5. 적용 예시

```js
import { useToken } from "../../hooks/useToken";
const { getUserInfoFromToken } = useToken();
const operatorId = getUserInfoFromToken()?.operatorId;

// 버스 추가 예시
const addBus = async (busData) => {
  const response = await axios.post("/api/buses", { ...busData, operatorId });
  // ...
};
```

---

## 6. 요청/응답 예시

### 1) 버스 목록 조회 (GET)
**요청**
```
GET /api/buses?operatorId=1
Authorization: Bearer {token}
```
**응답**
```json
[
  {
    "busId": 1,
    "operatorId": 1,
    "vehicleNumber": "서울70가1234",
    "routeNumber": "101",
    "capacity": 45,
    "vehicleType": "STANDARD",
    "vehicleYear": 2020,
    "lastMaintenance": "2024-01-15",
    "fuelType": "DIESEL"
  },
  ...
]
```

### 2) 버스 추가 (POST)
**요청**
```
POST /api/buses
Authorization: Bearer {token}
Content-Type: application/json

{
  "vehicleNumber": "서울70가5678",
  "routeNumber": "102",
  "capacity": 40,
  "vehicleType": "LARGE",
  "vehicleYear": 2022,
  "fuelType": "CNG",
  "operatorId": 1
}
```
**응답**
```json
{
  "busId": 2,
  "operatorId": 1,
  "vehicleNumber": "서울70가5678",
  "routeNumber": "102",
  "capacity": 40,
  "vehicleType": "LARGE",
  "vehicleYear": 2022,
  "fuelType": "CNG"
}
```

### 3) 버스 수정 (PUT)
**요청**
```
PUT /api/buses/2
Authorization: Bearer {token}
Content-Type: application/json

{
  "vehicleNumber": "서울70가5678",
  "routeNumber": "102",
  "capacity": 42,
  "vehicleType": "LARGE",
  "vehicleYear": 2022,
  "fuelType": "CNG",
  "operatorId": 1
}
```
**응답**
```json
{
  "busId": 2,
  "operatorId": 1,
  "vehicleNumber": "서울70가5678",
  "routeNumber": "102",
  "capacity": 42,
  "vehicleType": "LARGE",
  "vehicleYear": 2022,
  "fuelType": "CNG"
}
```

---

## 7. 결론

- **회사명 입력란은 제거**
- **operatorId는 항상 토큰에서 추출해서 API 요청에 자동 포함**
- **프론트에서 operatorId를 직접 입력받지 않음**
- **서버에서도 토큰의 operatorId와 요청값을 반드시 검증**

이 구조를 적용하면 회사별 데이터 분리와 보안이 자연스럽게 보장됩니다.